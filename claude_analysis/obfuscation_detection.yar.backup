/*
 * P4RS3LT0NGV3 Obfuscation Detection Rules
 * 
 * Detects various text obfuscation techniques used by LLM security research tools
 * including encoding, ciphers, Unicode manipulation, and steganography
 */

rule P4RS3LT0NGV3_Base64_Encoding {
    meta:
        description = "Detects Base64 encoded content"
        author = "Security Research"
        category = "encoding"
        technique = "base64"
        
    strings:
        $base64_pattern = /[A-Za-z0-9+\/]{4,}={0,2}/ fullword
        $base64_long = /[A-Za-z0-9+\/]{20,}={0,2}/
        
    condition:
        $base64_pattern or $base64_long
}

rule P4RS3LT0NGV3_Base32_Encoding {
    meta:
        description = "Detects Base32 encoded content"
        author = "Security Research"
        category = "encoding"
        technique = "base32"
        
    strings:
        $base32_pattern = /[A-Z2-7]{8,}={0,6}/ fullword
        
    condition:
        $base32_pattern
}

rule P4RS3LT0NGV3_Hexadecimal {
    meta:
        description = "Detects hexadecimal encoded text"
        author = "Security Research"
        category = "encoding"
        technique = "hexadecimal"
        
    strings:
        $hex_spaced = /([0-9A-Fa-f]{2}\s){3,}/
        $hex_continuous = /[0-9A-Fa-f]{6,}/
        
    condition:
        $hex_spaced or $hex_continuous
}

rule P4RS3LT0NGV3_Binary {
    meta:
        description = "Detects binary encoded text"
        author = "Security Research"
        category = "encoding"
        technique = "binary"
        
    strings:
        $binary_spaced = /([01]{8}\s){2,}/
        $binary_continuous = /[01]{16,}/
        
    condition:
        $binary_spaced or $binary_continuous
}

rule P4RS3LT0NGV3_ASCII85 {
    meta:
        description = "Detects ASCII85 encoded content"
        author = "Security Research"
        category = "encoding"
        technique = "ascii85"
        
    strings:
        $ascii85 = /<~[!-u]{4,}~>/
        
    condition:
        $ascii85
}

rule P4RS3LT0NGV3_URL_Encoding {
    meta:
        description = "Detects URL percent encoding"
        author = "Security Research"
        category = "encoding"
        technique = "url_encoding"
        
    strings:
        $url_encoded = /%[0-9A-Fa-f]{2}/
        
    condition:
        #url_encoded >= 3
}

rule P4RS3LT0NGV3_HTML_Entities {
    meta:
        description = "Detects HTML entity encoding"
        author = "Security Research"
        category = "encoding"
        technique = "html_entities"
        
    strings:
        $html_entity = /&[a-zA-Z0-9#]+;/
        
    condition:
        #html_entity >= 3
}

rule P4RS3LT0NGV3_ROT_Ciphers {
    meta:
        description = "Detects ROT13/ROT47 cipher patterns"
        author = "Security Research"
        category = "cipher"
        technique = "rot_cipher"
        
    strings:
        // Common ROT13 words
        $rot13_hello = "uryyb" nocase
        $rot13_world = "jbeyq" nocase
        $rot13_test = "grfg" nocase
        
        // ROT47 patterns (specific shifted characters)
        $rot47_pattern = /[#-&\(-Z\\\-\`\{-~]{8,}/
        
    condition:
        any of ($rot13_*) or $rot47_pattern
}

rule P4RS3LT0NGV3_Caesar_Cipher {
    meta:
        description = "Detects Caesar cipher patterns"
        author = "Security Research"
        category = "cipher"
        technique = "caesar_cipher"
        
    strings:
        // Common Caesar shifted words (shift of 3)
        $caesar_hello = "khoor" nocase
        $caesar_world = "zruog" nocase
        $caesar_attack = "dwwdfn" nocase
        
    condition:
        any of them
}

rule P4RS3LT0NGV3_Morse_Code {
    meta:
        description = "Detects Morse code patterns"
        author = "Security Research"
        category = "cipher"
        technique = "morse_code"
        
    strings:
        $morse_pattern = /[.\-\s\/]{10,}/
        $morse_sos = "... --- ..."
        
    condition:
        $morse_pattern or $morse_sos
}

rule P4RS3LT0NGV3_Upside_Down {
    meta:
        description = "Detects upside down text transformation"
        author = "Security Research"
        category = "unicode"
        technique = "upside_down"
        
    strings:
        // Specific upside down characters and sample
        $upside_down_sample = "ɥǝllo ʍoɹlp"
        $upside_down_chars = /[ɐqɔpǝɟƃɥᴉɾʞlɯuodbɹsʇnʌʍxʎz]{3,}/
        
    condition:
        any of them
}

rule P4RS3LT0NGV3_Small_Caps {
    meta:
        description = "Detects small caps Unicode transformation"
        author = "Security Research"
        category = "unicode"
        technique = "small_caps"
        
    strings:
        // Specific small caps sample and characters
        $small_caps_sample = "ʜᴇʟʟᴏ ᴡᴏʀʟᴅ"
        $small_caps_chars = /[ᴀʙᴄᴅᴇꜰɢʜɪᴊᴋʟᴍɴᴏᴘǫʀsᴛᴜᴠᴡxʏᴢ]{3,}/
        
    condition:
        any of them
}

rule P4RS3LT0NGV3_Bubble_Text {
    meta:
        description = "Detects bubble text Unicode transformation"
        author = "Security Research"
        category = "unicode"
        technique = "bubble_text"
        
    strings:
        // Specific bubble text sample and characters
        $bubble_sample = "Ⓗⓔⓛⓛⓞ Ⓦⓞⓡⓛⓓ"
        $bubble_chars = /[ⒶⒷⒸⒹⒺⒻⒼⒽⒾⒿⓀⓁⓂⓃⓄⓅⓆⓇⓈⓉⓊⓋⓌⓍⓎⓏⓐⓑⓒⓓⓔⓕⓖⓗⓘⓙⓚⓛⓜⓝⓞⓟⓠⓡⓢⓣⓤⓥⓦⓧⓨⓩ]{3,}/
        
    condition:
        any of them
}

rule P4RS3LT0NGV3_Full_Width {
    meta:
        description = "Detects full width Unicode characters"
        author = "Security Research"
        category = "unicode"
        technique = "full_width"
        
    strings:
        // Specific full width sample
        $full_width_sample = "Ｈｅｌｌｏ　Ｗｏｒｌｄ"
        $full_width_chars = /[Ａ-Ｚａ-ｚ０-９　]{3,}/
        
    condition:
        any of them
}

rule P4RS3LT0NGV3_Braille {
    meta:
        description = "Detects Braille Unicode characters"
        author = "Security Research"
        category = "unicode"
        technique = "braille"
        
    strings:
        // Specific braille sample
        $braille_sample = "⠓⠑⠇⠇⠕"
        $braille_chars = /[⠀-⣿]{3,}/
        
    condition:
        any of them
}

rule P4RS3LT0NGV3_Greek_Substitution {
    meta:
        description = "Detects Greek letter substitution"
        author = "Security Research"
        category = "unicode"
        technique = "greek_substitution"
        
    strings:
        // Specific Greek sample
        $greek_sample = "Ηελλο Ωορλδ"
        $greek_letters = /[Α-Ωα-ω]{3,}/
        
    condition:
        any of them
}

rule P4RS3LT0NGV3_Zalgo_Text {
    meta:
        description = "Detects Zalgo text (text with combining marks)"
        author = "Security Research"
        category = "visual"
        technique = "zalgo"
        
    strings:
        // Combining diacritical marks
        $combining_marks = /[\u0300-\u036f\u1ab0-\u1aff\u1dc0-\u1dff\u20d0-\u20ff\ufe20-\ufe2f]{3,}/
        
    condition:
        $combining_marks
}

rule P4RS3LT0NGV3_Strikethrough_Underline {
    meta:
        description = "Detects strikethrough and underline formatting"
        author = "Security Research"
        category = "visual"
        technique = "text_formatting"
        
    strings:
        // Strikethrough combining character
        $strikethrough = /.\u0336/
        
        // Underline combining character  
        $underline = /.\u0332/
        
    condition:
        #strikethrough >= 3 or #underline >= 3
}

rule P4RS3LT0NGV3_Invisible_Characters {
    meta:
        description = "Detects invisible Unicode characters used for steganography"
        author = "Security Research"
        category = "steganography"
        technique = "invisible_text"
        
    strings:
        // Private use area characters used for invisible text
        $invisible_chars = /[\ue0000-\ue007f]{5,}/
        
        // Zero-width characters pattern for steganography
        $zero_width_stego = /[\u200b-\u200f]{5,}/
        
        // Invisible text sample from our test data
        $invisible_sample = "‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌‌"
        
        // Variation selectors (but only in large quantities suggesting steganography)
        $variation_selectors = /[\ufe00-\ufe0f]{8,}/
        
    condition:
        any of them
}

rule P4RS3LT0NGV3_Emoji_Steganography {
    meta:
        description = "Detects emoji steganography using variation selectors"
        author = "Security Research"
        category = "steganography"
        technique = "emoji_steganography"
        
    strings:
        // Emoji followed by many variation selectors (steganography pattern)
        $emoji_snake_stego = "🐍︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎︎‍"
        $variation_pattern = /[\uFE0E\uFE0F]{15,}/
        $emoji_with_vs = /[\u2600-\u26FF][\uFE0E\uFE0F]{10,}/
        
    condition:
        any of them
}

rule P4RS3LT0NGV3_NATO_Phonetic {
    meta:
        description = "Detects NATO phonetic alphabet usage"
        author = "Security Research"
        category = "substitution"
        technique = "nato_phonetic"
        
    strings:
        $nato1 = "Alpha" nocase
        $nato2 = "Bravo" nocase
        $nato3 = "Charlie" nocase
        $nato4 = "Delta" nocase
        $nato5 = "Echo" nocase
        $nato6 = "Foxtrot" nocase
        $nato7 = "Golf" nocase
        $nato8 = "Hotel" nocase
        
    condition:
        #nato1 + #nato2 + #nato3 + #nato4 + #nato5 + #nato6 + #nato7 + #nato8 >= 3
}

rule P4RS3LT0NGV3_Leetspeak {
    meta:
        description = "Detects leetspeak character substitution"
        author = "Security Research"
        category = "substitution"
        technique = "leetspeak"
        
    strings:
        // Common leetspeak patterns
        $leet_pattern = /[h3ll0w0rld47]/i
        $leet_hello = "h3ll0" nocase
        $leet_world = "w0rld" nocase
        $leet_leet = "1337" nocase
        
    condition:
        any of them
}

rule P4RS3LT0NGV3_Pig_Latin {
    meta:
        description = "Detects Pig Latin word transformation"
        author = "Security Research"
        category = "substitution"
        technique = "pig_latin"
        
    strings:
        // Pig Latin suffixes
        $pig_latin_way = /\b\w+way\b/
        $pig_latin_ay = /\b\w+ay\b/
        
    condition:
        #pig_latin_way >= 2 or #pig_latin_ay >= 3
}

rule P4RS3LT0NGV3_Runic_Elder_Futhark {
    meta:
        description = "Detects Elder Futhark runic characters"
        author = "Security Research"
        category = "unicode"
        technique = "elder_futhark"
        
    strings:
        // Specific Elder Futhark sample
        $elder_futhark_sample = "\u16ba\u16d6\u16da\u16da\u16df"
        $runes = /[ᚠ-ᛟ]{3,}/
        
    condition:
        any of them
}

rule P4RS3LT0NGV3_Wingdings_Symbols {
    meta:
        description = "Detects Wingdings-style symbol substitution"
        author = "Security Research"
        category = "substitution"
        technique = "wingdings"
        
    strings:
        // Specific wingdings-style patterns using Unicode ranges
        $wingdings1 = "♒♏●●⚬"
        $symbols1 = /[\u2660-\u2667]{3,}/
        $symbols2 = /[\u2701-\u270D]{3,}/
        $symbols3 = /[\u2713-\u271C]{3,}/
        
    condition:
        any of them
}

rule P4RS3LT0NGV3_Mathematical_Fonts {
    meta:
        description = "Detects mathematical Unicode fonts"
        author = "Security Research"
        category = "unicode"
        technique = "mathematical_fonts"
        
    strings:
        // Specific samples from test data
        $medieval_sample = "𝖍𝖊𝖑𝖑𝖔 𝖜𝖔𝖗𝖑𝖉"
        $cursive_sample = "𝓱𝓮𝓵𝓵𝓸 𝔀𝓸𝓻𝓵𝓭"
        $monospace_sample = "𝚑𝚎𝚕𝚕𝚘 𝚠𝚘𝚛𝚕𝚍"
        $double_struck_sample = "𝕙𝕖𝕝𝕝𝕠 𝕨𝕠𝕣𝕝𝕕"
        
        // Mathematical Alphanumeric Symbols - specific patterns to avoid false positives
        $math_bold = /𝐀-𝐙𝐚-𝐳/
        $math_italic = /𝐴-𝑍𝑎-𝑧/
        $math_script = /𝒜-𝒵𝒶-𝓏/
        $math_fraktur = /𝔄-𝔝𝔞-𝔷/
        $math_monospace = /𝙰-𝚉𝚊-𝚣/
        
    condition:
        any of them
}

rule P4RS3LT0NGV3_Multiple_Obfuscation {
    meta:
        description = "Detects content with multiple obfuscation techniques"
        author = "Security Research"
        category = "combined"
        technique = "multiple_obfuscation"
        
    condition:
        // Trigger if multiple different obfuscation rules match
        (P4RS3LT0NGV3_Base64_Encoding and P4RS3LT0NGV3_Hexadecimal) or
        (P4RS3LT0NGV3_Upside_Down and P4RS3LT0NGV3_ROT_Ciphers) or
        (P4RS3LT0NGV3_Invisible_Characters and P4RS3LT0NGV3_Base64_Encoding) or
        // Multiple combination patterns
        (P4RS3LT0NGV3_Base64_Encoding and P4RS3LT0NGV3_Base32_Encoding and P4RS3LT0NGV3_Binary) or
        (P4RS3LT0NGV3_Upside_Down and P4RS3LT0NGV3_Greek_Substitution and P4RS3LT0NGV3_Braille)
}

rule P4RS3LT0NGV3_Suspicious_Patterns {
    meta:
        description = "Detects suspicious patterns that may indicate obfuscation"
        author = "Security Research"
        category = "heuristic"
        technique = "suspicious_patterns"
        
    strings:
        // Very long strings of repeated characters (possible padding)
        $repeated_chars = /(a{10,}|b{10,}|c{10,}|d{10,}|e{10,}|f{10,}|g{10,}|h{10,}|i{10,}|j{10,}|k{10,}|l{10,}|m{10,}|n{10,}|o{10,}|p{10,}|q{10,}|r{10,}|s{10,}|t{10,}|u{10,}|v{10,}|w{10,}|x{10,}|y{10,}|z{10,}|A{10,}|B{10,}|C{10,}|D{10,}|E{10,}|F{10,}|G{10,}|H{10,}|I{10,}|J{10,}|K{10,}|L{10,}|M{10,}|N{10,}|O{10,}|P{10,}|Q{10,}|R{10,}|S{10,}|T{10,}|U{10,}|V{10,}|W{10,}|X{10,}|Y{10,}|Z{10,}|0{10,}|1{10,}|2{10,}|3{10,}|4{10,}|5{10,}|6{10,}|7{10,}|8{10,}|9{10,}|={10,})/
        
        // Strings with very high entropy (random-looking)
        $high_entropy = /[A-Za-z0-9+\/=]{50,}/
        
        // Mixed scripts in short text (suspicious) - simplified for compatibility
        $mixed_scripts = /[A-Za-z]{1,3}[\u03B1-\u03C9]{1,3}/
        
    condition:
        any of them
}

rule P4RS3LT0NGV3_Master_Detection {
    meta:
        description = "Master rule that detects any P4RS3LT0NGV3 obfuscation technique"
        author = "Security Research"
        category = "master"
        technique = "any_obfuscation"
        
    condition:
        P4RS3LT0NGV3_Base64_Encoding or
        P4RS3LT0NGV3_Base32_Encoding or
        P4RS3LT0NGV3_Hexadecimal or
        P4RS3LT0NGV3_Binary or
        P4RS3LT0NGV3_ASCII85 or
        P4RS3LT0NGV3_URL_Encoding or
        P4RS3LT0NGV3_HTML_Entities or
        P4RS3LT0NGV3_ROT_Ciphers or
        P4RS3LT0NGV3_Caesar_Cipher or
        P4RS3LT0NGV3_Morse_Code or
        P4RS3LT0NGV3_Upside_Down or
        P4RS3LT0NGV3_Small_Caps or
        P4RS3LT0NGV3_Bubble_Text or
        P4RS3LT0NGV3_Full_Width or
        P4RS3LT0NGV3_Braille or
        P4RS3LT0NGV3_Greek_Substitution or
        P4RS3LT0NGV3_Zalgo_Text or
        P4RS3LT0NGV3_Strikethrough_Underline or
        P4RS3LT0NGV3_Invisible_Characters or
        P4RS3LT0NGV3_Emoji_Steganography or
        P4RS3LT0NGV3_NATO_Phonetic or
        P4RS3LT0NGV3_Leetspeak or
        P4RS3LT0NGV3_Pig_Latin or
        P4RS3LT0NGV3_Runic_Elder_Futhark or
        P4RS3LT0NGV3_Wingdings_Symbols or
        P4RS3LT0NGV3_Mathematical_Fonts or
        P4RS3LT0NGV3_Suspicious_Patterns
}